name: CI Pipeline

on:
  pull_request:
    branches: [development, main]
  workflow_dispatch:

jobs:
  frontend-build:
    name: Frontend Build & Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Run ESLint
        working-directory: ./frontend
        run: npm run lint

      - name: Build Next.js application
        working-directory: ./frontend
        run: npm run build
        env:
          NEXT_PUBLIC_API_URL: http://localhost:8080

  backend-build:
    name: Backend Build & Compile
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "21"
          cache: "maven"

      - name: Verify application.properties
        working-directory: ./backend
        run: |
          CHANGEME_COUNT=$(grep -o "changeme" src/main/resources/application.properties | wc -l)
          if [ "$CHANGEME_COUNT" -ne 2 ]; then
            echo "❌ application.properties validation failed"
            exit 1
          fi
          echo "✅ application.properties validation passed"

      - name: Make Maven wrapper executable
        working-directory: ./backend
        run: chmod +x mvnw

      - name: Compile backend
        working-directory: ./backend
        run: ./mvnw clean compile

      - name: Validate Dockerfile
        working-directory: ./backend
        run: |
          if [ ! -f Dockerfile ]; then
            echo "❌ Dockerfile not found"
            exit 1
          fi
          echo "✅ Dockerfile validation passed"

      - name: Check for dependency conflicts
        working-directory: ./backend
        run: ./mvnw dependency:tree

  frontend-e2e:
    name: Frontend E2E Tests (Cypress)
    runs-on: ubuntu-latest
    needs: frontend-build
    services:
      mysql:
        image: mysql:8
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: jj_apartments
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping --silent"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Wait for MySQL to be healthy
      - name: Wait for MySQL
        run: |
          until mysqladmin ping -h 127.0.0.1 -P 3306 --silent; do
            echo "Waiting for MySQL..."
            sleep 2
          done

      # Load SQL schema into MySQL
      - name: Load database schema
        run: |
          mysql -h 127.0.0.1 -P 3306 -u root -proot jj_apartments < backend/src/database/jj_apartments.sql

      # Setup Java and build + start backend
      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
          cache: maven

      - name: Make Maven wrapper executable
        working-directory: ./backend
        run: chmod +x mvnw

      - name: Build backend JAR
        working-directory: ./backend
        run: ./mvnw -q -DskipTests package

      - name: Start backend
        working-directory: ./backend
        run: |
          java -jar target/*.jar &
        env:
          DATABASE_URL: jdbc:mysql://127.0.0.1:3306/jj_apartments?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=UTC
          DATABASE_USERNAME: root
          DATABASE_PASSWORD: root

      # Setup Node and frontend for tests
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Wait for backend to be ready
        working-directory: ./frontend
        run: npx wait-on --timeout 180000 http://localhost:8080

      - name: Run Cypress E2E tests
        working-directory: ./frontend
        run: npm run test:e2e:ci
        env:
          NEXT_PUBLIC_API_URL: http://localhost:8080

      - name: Upload Cypress screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-screenshots
          path: frontend/cypress/screenshots
          retention-days: 7

      - name: Upload Cypress videos
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-videos
          path: frontend/cypress/videos
          retention-days: 7

  ci-complete:
    name: CI Pipeline Complete
    runs-on: ubuntu-latest
    needs: [frontend-build, backend-build, frontend-e2e]
    if: success()
    steps:
      - run: echo "✅ All CI checks passed successfully! PR is ready to merge"

  notify-success:
    name: Notify Success
    runs-on: ubuntu-latest
    needs: [frontend-build, backend-build, frontend-e2e]
    if: success()
    steps:
      - name: Send Discord notification
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          curl -H "Content-Type: application/json" \
               -d "{\"content\": \"✅ **CI Passed** - PR #${{ github.event.pull_request.number }}: ${{ github.event.pull_request.title }}\n<${{ github.event.pull_request.html_url }}>\"}" \
               $DISCORD_WEBHOOK

  notify-failure:
    name: Notify Failure
    runs-on: ubuntu-latest
    needs: [frontend-build, backend-build, frontend-e2e]
    if: failure()
    steps:
      - name: Send Discord notification
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          curl -H "Content-Type: application/json" \
               -d "{\"content\": \"❌ **CI Failed** - PR #${{ github.event.pull_request.number }}: ${{ github.event.pull_request.title }}\n<${{ github.event.pull_request.html_url }}>\n\nCheck the logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\"}" \
               $DISCORD_WEBHOOK
