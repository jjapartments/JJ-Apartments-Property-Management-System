name: CI Pipeline

on:
  pull_request:
    branches: [development, main]
  workflow_dispatch:

jobs:
  frontend-build:
    name: Frontend Build & Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Run ESLint
        working-directory: ./frontend
        run: npm run lint

      - name: Build Next.js application
        working-directory: ./frontend
        run: npm run build
        env:
          NEXT_PUBLIC_API_URL: http://localhost:8080

  backend-build:
    name: Backend Build & Compile
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "21"
          cache: "maven"

      - name: Verify application.properties
        working-directory: ./backend
        run: |
          CHANGEME_COUNT=$(grep -o "changeme" src/main/resources/application.properties | wc -l)

          if [ "$CHANGEME_COUNT" -ne 2 ]; then
            echo "❌ ERROR: application.properties validation failed"
            echo "Expected exactly 2 occurrences of 'changeme' (username and password placeholders)"
            echo "Found: $CHANGEME_COUNT occurrences"
            echo ""
            echo "This usually means:"
            echo "  - Hardcoded credentials were committed (too few 'changeme')"
            echo "  - Template was modified incorrectly (wrong count)"
            echo ""
            echo "Please ensure application.properties uses the template format:"
            echo "  spring.datasource.username=\${DATABASE_USERNAME:changeme}"
            echo "  spring.datasource.password=\${DATABASE_PASSWORD:changeme}"
            exit 1
          fi

          echo "✅ application.properties validation passed (2 'changeme' placeholders found)"

      - name: Make Maven wrapper executable
        working-directory: ./backend
        run: chmod +x mvnw

      - name: Compile backend
        working-directory: ./backend
        run: ./mvnw clean compile

      - name: Validate Dockerfile
        working-directory: ./backend
        run: |
          if [ ! -f Dockerfile ]; then
            echo "❌ ERROR: Dockerfile not found"
            exit 1
          fi
          echo "✅ Dockerfile validation passed"

      - name: Check for dependency conflicts
        working-directory: ./backend
        run: ./mvnw dependency:tree

  # Optional: Enable by changing if false to true
  frontend-test:
    name: Frontend Tests
    runs-on: ubuntu-latest
    needs: frontend-build
    if: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Run tests
        working-directory: ./frontend
        run: npm test

  # Optional: Enable by changing if false to true
  backend-test:
    name: Backend Tests
    runs-on: ubuntu-latest
    needs: backend-build
    if: false

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: testpassword
          MYSQL_DATABASE: testdb
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "21"
          cache: "maven"

      - name: Make Maven wrapper executable
        working-directory: ./backend
        run: chmod +x mvnw

      - name: Run tests
        working-directory: ./backend
        run: ./mvnw test
        env:
          SPRING_DATASOURCE_URL: jdbc:mysql://localhost:3306/testdb
          SPRING_DATASOURCE_USERNAME: root
          SPRING_DATASOURCE_PASSWORD: testpassword

  ci-complete:
    name: CI Pipeline Complete
    runs-on: ubuntu-latest
    needs: [frontend-build, backend-build]
    if: success()

    steps:
      - name: All checks passed
        run: |
          echo "✅ All CI checks passed successfully!"
          echo "PR is ready to merge"

  notify-success:
    name: Notify Success
    runs-on: ubuntu-latest
    needs: [frontend-build, backend-build]
    if: success()

    steps:
      - name: Send Discord notification
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          curl -H "Content-Type: application/json" \
               -d "{\"content\": \"✅ **CI Passed** - PR #${{ github.event.pull_request.number }}: ${{ github.event.pull_request.title }}\n<${{ github.event.pull_request.html_url }}>\"}" \
               $DISCORD_WEBHOOK

  notify-failure:
    name: Notify Failure
    runs-on: ubuntu-latest
    needs: [frontend-build, backend-build]
    if: failure()

    steps:
      - name: Send Discord notification
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          curl -H "Content-Type: application/json" \
               -d "{\"content\": \"❌ **CI Failed** - PR #${{ github.event.pull_request.number }}: ${{ github.event.pull_request.title }}\n<${{ github.event.pull_request.html_url }}>\n\nCheck the logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\"}" \
               $DISCORD_WEBHOOK
